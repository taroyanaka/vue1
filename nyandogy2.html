<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>クリーチャー管理</title>
    <script src="./crtTemplates.js"></script>
    <script src="./vue3.js"></script>
    <style>
        .crt { margin: 0px; padding: 0px; border: 1px solid #ccc; }
        .message-container {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            text-align: center;
            padding: 10px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }
    </style>
<!--
crt -> creature
fu -> fullness
ha -> happiness
pp -> poop
mPp -> maxPoop
gld -> gold
ev -> evolution
nNm -> newName
nEm -> newEmoji
nGd -> newGold
tm -> time
fd -> food
hd -> happinessDecrease
pb -> progressBar
rem -> remaining
mny -> money
-->
</head>
<body>
    <div id="app">
        <div class="message-container">
            <div v-for="crt in crts" :key="crt.id">{{ crt.message }}</div>
        </div>
        <h3>💰: {{ mny }} mny  🪦: {{ deathCount }} ⏱️: {{ totalInterval }}</h3>
        
        <div v-for="crt in crts" :key="crt.id" class="crt">
            🍴<span @click="feed(crt)">{{ crt.fu }} / {{ crt.ev[crt.type]?.fu || 100 }}
                <progress :value="crt.fu" max="100">{{ crt.fu }}%</progress>
            </span>
            🛝<span @click="play(crt)">{{ crt.ha }} / {{ crt.ev[crt.type]?.ha || 100 }}
                <progress :value="crt.ha" max="100">{{ crt.ha }}%</progress>
            </span>
            💩<span @click="toilet(crt)">{{ crt.pp }} / {{ crt.mPp }}
                <progress :value="crt.pp" :max="crt.mPp">{{ crt.pp }}/{{ crt.mPp }}</progress>
            </span>
            <span v-if="crt.type < crt.ev.length">💩{{ crt.ev[crt.type].pp }}</span>

            ⏱️<progress :value="crt.pb" max="100">{{ crt.rem }}</progress>
            {{ crt.emoji }} {{ crt.name }}: 💰{{ crt.gld }} gld
            <!-- 売却 -->
            <button @click="sellcrt(crt)">売却</button>
        </div>

        <h2>クリーチャー購入</h2>
        <div v-for="template in crtTemplates" :key="template.id" class="crt">
            <h4>{{ template.emoji }} {{ template.name }}: 💰{{ template.gld }} gld</h4>
            <button @click="buycrt(template)">購入 ({{ discountPrice(template.price) }} mny)</button>
        </div>


        <h2>設定</h2>
        <div>
            <label>満腹度減少間隔: <input type="number" v-model.number="settings.fd" min="1"></label>
            <label>幸せ度減少間隔: <input type="number" v-model.number="settings.hd" min="1"></label>
            <label>進化間隔: <input type="number" v-model.number="settings.tm" min="1"></label>
        </div>

    </div>

<script>
    const app = Vue.createApp({
        data() {
            return {
                totalInterval: 0,
                deathCount: 0,
                crts: [],
                crtTemplates: null,
                settings: { fd: 1, hd: 1, tm: 1 },
                timer: null,
                mny: 500 // プレイヤーのマネー
            };
        },
        async mounted() {
            this.crtTemplates = crtTemplates;
            this.startTimer();
        },
        computed: {
            totalppCount() {
                return this.crts.reduce((total, c) => total + c.pp, 0);
            }
        },
        methods: {
            feed(c) { this.modifyStat(c, 'fu', 10); },
            play(c) { this.modifyStat(c, 'ha', 10); },
            toilet(c) { this.modifyStat(c, 'pp', -c.pp); },
            modifyStat(c, stat, value) {
                if (!c.alive) return;
                c[stat] = Math.min(Math.max(c[stat] + value, 0), 100);
                this.checkAlive(c);
            },
            evolve(c) {
                if (c.type >= c.ev.length) return;
                const ev = c.ev[c.type];
                ev && c.fu >= ev.fu && c.ha >= ev.ha && c.pp <= ev.pp
                    ? Object.assign(c, { name: ev.nNm, emoji: ev.nEm, gld: ev.nGd, mPp: ev.mPp, type: c.type + 1, message: `${c.name}が進化した！` })
                    : c.message = `${c.name}は進化できません。条件を満たしていません。`;
            },
            checkAlive(c) {
                c.fu <= 0 || c.ha <= 0 || c.pp >= c.mPp
                    ? (Object.assign(c, { alive: false, message: `${c.name}は亡くなりました。` }), this.deathCount++, this.crts = this.crts.filter(crt => crt.id !== c.id))
                    : c.message = '';
            },
            buycrt(template) {
                this.mny >= template.price && (this.mny -= this.discountPrice(template.price), this.crts.push({ ...template, id: Date.now() }));
            },
            discountPrice(price) {
                return price - Math.floor(this.crts.length * 0.01 * price);
            },
            sellcrt(crt) {
                this.mny += crt.price / 2;
                this.crts = this.crts.filter(c => c.id !== crt.id);
            },
            startTimer() {
                this.timer = setInterval(() => {
                    this.crts.forEach(c => {
                        if (c.alive) {
                            this.modifyStat(c, 'fu', -this.settings.fd);
                            this.modifyStat(c, 'ha', -this.settings.hd);
                            c.rem -= this.settings.tm;
                            c.pp++;
                            this.checkAlive(c);
                            c.rem <= 0 && (this.evolve(c), c.rem = 10);
                            c.pb = (c.rem / 10) * 100;
                            this.mny += c.gld;
                        }
                    });
                    this.totalInterval++;
                }, 1000);
            },
            stopTimer() { clearInterval(this.timer); this.timer = null; }
        },
        beforeUnmount() {
            this.stopTimer();
        }
    }).mount('#app');
</script>

</body>
</html>